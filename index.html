<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de carroyage CADO</title>

    <!-- Bibliothèques CSS externes -->
    <link href="tailwind.min.css" rel="stylesheet">
    <link href="flowbite.min.css" rel="stylesheet">
    
    <!-- Votre feuille de style locale -->
    <link rel="stylesheet" href="style.css">

    <!-- Bibliothèques JS externes -->
    <script src="version.js"></script>
    <script src="jszip.min.js"></script>
    <script src="FileSaver.min.js"></script>
    <script src="openlocationcode.min.js"></script>
    
    <!-- Scripts d'icônes -->
    <script src="FFFFFF-images.js"></script>
    <script src="000000-images.js"></script>
    <script src="FF0000-images.js"></script>
    <script src="FFA500-images.js"></script>
    <script src="FFFF00-images.js"></script>
    <script src="008000-images.js"></script>
    <script src="0000FF-images.js"></script>
    <script src="800080-images.js"></script>
    <script src="A52A2A-images.js"></script>
    <script src="808080-images.js"></script>
</head>

<body class="p-4 md:p-6">
    <div class="max-w-5xl mx-auto">
        <header class="mb-6 text-center">
             <h1 id="app-title" class="text-2xl md:text-3xl font-bold mb-4 text-content">Générateur de carroyage CADO</h1>
             <div class="flex flex-wrap justify-center gap-2 mb-4">
                 <button id="helpBtn" class="text-2xl px-3 py-1 rounded-full button-outline bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white">?</button>
                 <a href="https://www.google.com/maps" target="_blank" class="px-3 py-1 button-outline bg-gray-200 hover:bg-gray-300 rounded dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white text-sm md:text-base">Ouvrir Google Maps</a>
                 <a href="https://www.google.com/mymaps" target="_blank" class="px-3 py-1 button-outline bg-gray-200 hover:bg-gray-300 rounded dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white text-sm md:text-base">Ouvrir Google MyMaps</a>
                 <a href="https://earth.google.com/web/" target="_blank" class="px-3 py-1 button-outline bg-gray-200 hover:bg-gray-300 rounded dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white text-sm md:text-base">Ouvrir Google Earth</a>
             </div>
        </header>

        <main class="space-y-6">
            <!-- CADO Grid Generator -->
            <div class="card bg-white shadow-md rounded-lg p-4 md:p-6 dark:bg-gray-800 dark:border dark:border-gray-700">
                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-content">Coordonnées (Point de référence CADO)</h3>
                    <div class="space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0">
                            <label for="decimal-coords" class="md:w-1/3 text-sm md:text-base text-content">Coordonnées GPS (décimal) :</label>
                            <div class="md:w-2/3 flex space-x-2">
                                <input type="text" id="decimal-coords" class="input-field w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="Lat, Long (ex: 48.8566, 2.3522)">
                                <button id="convert-from-decimal" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm md:text-base">Convertir</button>
                                <button id="view-on-maps-decimal" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm md:text-base">Voir sur Maps</button>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0">
                            <label for="dms-coords" class="md:w-1/3 text-sm md:text-base text-content">Coordonnées GPS (DMS) :</label>
                            <div class="md:w-2/3 flex space-x-2">
                                <input type="text" id="dms-coords" class="input-field w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="ex: 48°51'23.7''N 2°21'07.9''E">
                                <button id="convert-from-dms" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm md:text-base">Convertir</button>
                                <button id="view-on-maps-dms" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm md:text-base">Voir sur Maps</button>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0" hidden>
                            <label for="plus-code" class="md:w-1/3 text-sm md:text-base text-content" hidden>Plus Code :</label>
                            <div class="md:w-2/3 flex space-x-2" hidden>
                                <input type="text" id="plus-code" class="input-field w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="ex: 8FW4V75V+ ou EW47+QV Paris" hidden>
                                <button id="convert-from-plus" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm md:text-base" hidden>Convertir</button>
                                <button id="view-on-maps-plus" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm md:text-base" hidden>Voir sur Maps</button>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0">
                            <label for="mercator-coords" class="md:w-1/3 text-sm md:text-base text-content">Coordonnées MERCATOR :</label>
                            <div class="md:w-2/3 flex space-x-2">
                                <input type="text" id="mercator-coords" class="input-field w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="ex: 263726.05, 6250958.43">
                                <button id="convert-from-mercator" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm md:text-base">Convertir</button>
                                <button id="view-on-maps-mercator" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm md:text-base">Voir sur Maps</button>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0">
                            <label for="utm-coords" class="md:w-1/3 text-sm md:text-base text-content">Coordonnées UTM :</label>
                            <div class="md:w-2/3 flex space-x-2">
                                <input type="text" id="utm-coords" class="input-field w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="Zone Lettre Easting Northing (ex: 31 U 448252 5411943)">
                                <button id="convert-from-utm" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm md:text-base">Convertir</button>
                                <button id="view-on-maps-utm" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm md:text-base">Voir sur Maps</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-content">Configuration du carroyage CADO</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <div class="flex flex-col space-y-1">
                                <label for="scale" class="text-sm md:text-base text-content">Échelle (en mètres) :</label>
                                <input type="number" id="scale" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="20">
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm md:text-base text-content">Choisir une couleur :</label>
                                <div class="flex flex-wrap gap-2" id="color-options">
                                    <div class="color-option selected" data-color="#FFFFFF" data-name="white" style="background-color: #FFFFFF; border: 1px solid #ccc;"></div>
                                    <div class="color-option" data-color="#000000" data-name="black" style="background-color: #000000;"></div>
                                    <div class="color-option" data-color="#FF0000" data-name="red" style="background-color: #FF0000;"></div>
                                    <div class="color-option" data-color="#FFA500" data-name="orange" style="background-color: #FFA500;"></div>
                                    <div class="color-option" data-color="#FFFF00" data-name="yellow" style="background-color: #FFFF00;"></div>
                                    <div class="color-option" data-color="#008000" data-name="green" style="background-color: #008000;"></div>
                                    <div class="color-option" data-color="#0000FF" data-name="blue" style="background-color: #0000FF;"></div>
                                    <div class="color-option" data-color="#800080" data-name="violet" style="background-color: #800080;"></div>
                                    <div class="color-option" data-color="#A52A2A" data-name="brown" style="background-color: #A52A2A;"></div>
                                    <div class="color-option" data-color="#808080" data-name="gray" style="background-color: #808080;"></div>
                                </div>
                                <input type="hidden" id="grid-color" value="#FFFFFF">
                                <input type="hidden" id="grid-color-name" value="white" class="grid-parameter">
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label for="transparency" class="text-sm md:text-base text-content">Transparence :</label>
                                <div class="flex space-x-2 items-center">
                                    <input type="range" id="transparency" class="w-full grid-parameter" min="0" max="100" value="20">
                                    <span id="transparency-value" class="text-sm text-content">20%</span>
                                </div>
                            </div>
                            
                            <div class="flex space-x-4">
                                <div class="flex-1 flex flex-col space-y-1">
                                    <label for="label-size" class="text-sm md:text-base text-content">Taille du texte :</label>
                                    <input type="number" id="label-size" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="1.2" min="0.5" max="3" step="0.1">
                                </div>
                                <div class="flex-1 flex flex-col space-y-1">
                                    <label for="icon-size" class="text-sm md:text-base text-content">Taille des icônes :</label>
                                    <input type="number" id="icon-size" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="2" min="0.5" max="5" step="0.1">
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label for="grid-name-base" class="text-sm md:text-base text-content">Nom du carroyage :</label>
                                <input type="text" id="grid-name-base" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="CADO Grid">
                                <input type="hidden" id="grid-name" value="CADO Grid">
                                <div id="full-grid-name" class="text-sm text-secondary mt-1 overflow-auto max-h-20 border-l-2 border-blue-500 pl-2 italic">CADO Grid_20m_center_Q12_white</div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm md:text-base text-content">Point de référence :</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="reference-point" value="center" class="custom-radio grid-parameter" checked>
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Milieu du carroyage</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="reference-point" value="origin" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Origine (A1)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm md:text-base text-content">Orientation des lettres :</label>
                                <div class="flex gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="lettering-direction" value="ascending" class="custom-radio grid-parameter" checked>
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Ascendante (Sud→Nord)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="lettering-direction" value="descending" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Descendante (Nord→Sud)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm md:text-base text-content">Option de grille :</label>
                                <div class="flex gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="grid-option" value="default" class="custom-radio grid-parameter" checked>
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Grille par défaut</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="grid-option" value="custom" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Grille custom</span>
                                    </label>
                                </div>
                            </div>
                            
                             <div id="default-grid-options" class="flex flex-col space-y-1">
                                <label class="text-sm md:text-base text-content">Type de grille :</label>
                                <div class="flex flex-wrap gap-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="grid-type" value="Q12" class="custom-radio grid-parameter" checked>
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Q12 (17x12 - Imprimable)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="grid-type" value="Z18" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Z18 (26x18)</span>
                                    </label>
                                     <label class="inline-flex items-center">
                                        <input type="radio" name="grid-type" value="Z14" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Z14 (26x14)</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="grid-type" value="Z26" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Z26 (26x26)</span>
                                    </label>
                                    <label class="inline-flex items-center" hidden>
                                        <input type="radio" name="grid-type" value="Q9" class="custom-radio grid-parameter">
                                        <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline">Q9 (17x9)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div id="custom-grid-options" class="hidden space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex flex-col space-y-1">
                                        <label for="start-row" class="text-sm text-content">Début des lignes (nombres) :</label>
                                        <input type="number" id="start-row" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="1">
                                    </div>
                                    <div class="flex flex-col space-y-1">
                                        <label for="end-row" class="text-sm text-content">Fin des lignes (nombres) :</label>
                                        <input type="number" id="end-row" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="26">
                                    </div>
                                    <div class="flex flex-col space-y-1">
                                        <label for="start-col" class="text-sm text-content">Début des colonnes (lettres) :</label>
                                        <input type="text" id="start-col" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="A">
                                    </div>
                                    <div class="flex flex-col space-y-1">
                                        <label for="end-col" class="text-sm text-content">Fin des colonnes (lettres) :</label>
                                        <input type="text" id="end-col" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base grid-parameter" value="Z">
                                    </div>
                                </div>
                                <p class="text-xs text-secondary">
                                    * Pour une grille personnalisée :<br>
                                        - Les lignes peuvent aller de -26 à 52.<br>
                                        - Les colonnes doivent être comprises entre -Z et AZ.<br>
                                        - Il n'y a pas de ligne/colonne 0.
                                </p>
                            </div>
                            
                            <div class="flex flex-col space-y-1">
                                <div class="flex items-center justify-between">
                                    <label for="deviation" class="text-sm md:text-base text-content">Déviation (en degrés) :</label>
                                    <button id="reset-deviation" class="px-2 py-1 text-xs bg-gray-200 hover:bg-gray-300 rounded dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white reset-btn">Réinitialiser</button>
                                </div>
                                <div class="flex space-x-2 items-center">
                                    <input type="range" id="deviation" class="w-full grid-parameter" min="-180" max="180" value="0">
                                    <span id="deviation-value" class="text-sm text-content">0°</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-content">Format de sortie (CADO)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <h4 class="font-medium text-content">Format du fichier :</h4>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="file-format" value="KML" class="custom-radio">
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-24 text-center">KML</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="file-format" value="KMZ" class="custom-radio" checked>
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-24 text-center">KMZ</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="file-format" value="GeoJSON" class="custom-radio">
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-24 text-center">GeoJSON</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="file-format" value="GPX" class="custom-radio">
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-24 text-center">GPX (OSMAND)</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <h4 class="font-medium text-content">Contenu :</h4>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="content-type" value="grid-only" class="custom-radio">
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-28 text-center">Grille seule</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="content-type" value="points-only" class="custom-radio">
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-28 text-center">Points seuls</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="content-type" value="grid-points" class="custom-radio" checked>
                                    <span class="px-3 py-1 border border-default rounded cursor-pointer text-sm button-outline w-28 text-center">Grille + Points</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="flex flex-wrap justify-center items-center gap-4">
                    <button id="generate-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow-lg transform transition duration-200 hover:scale-105">GÉNÉRER CARROYAGE CADO</button>
                    
                    <div class="flex items-center gap-2">
                        <button id="generate-image-button" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow-lg transform transition duration-200 hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">Générer l'image (PNG)</button>
                        <div class="flex flex-col">
                            <label for="map-tile-provider" class="text-xs text-center text-content mb-1">Fond</label>
                            <select id="map-tile-provider" class="input-field px-2 py-1 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-sm">
                                <option value="http://ecn.t{s}.tiles.virtualearth.net/tiles/h{q}.jpeg?g=14927" selected>Bing Hybrid</option>
                                <option value="https://tile.openstreetmap.org/{z}/{x}/{y}.png">OSM Standard</option>
                                <option value="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}">Satellite (Esri)</option>
                            </select>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- UTM Grid Generator -->
            <div class="card bg-white shadow-md rounded-lg p-4 md:p-6 dark:bg-gray-800 dark:border dark:border-gray-700">
                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-content">Générateur de Grille UTM (1km)</h3>
                    <div class="space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0">
                            <label for="utm-nw-coords" class="md:w-1/3 text-sm md:text-base text-content">Coordonnée Nord-Ouest (NO) :</label>
                            <input type="text" id="utm-nw-coords" class="input-field md:w-2/3 w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="Lat, Long (ex: 49.0, 2.0)">
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0">
                            <label for="utm-se-coords" class="md:w-1/3 text-sm md:text-base text-content">Coordonnée Sud-Est (SE) :</label>
                            <input type="text" id="utm-se-coords" class="input-field md:w-2/3 w-full px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" placeholder="Lat, Long (ex: 48.5, 2.5)">
                        </div>
                    </div>
                </section>
                
                <section class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-content">Configuration de la grille UTM</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-3">
                            <div class="flex flex-col space-y-1">
                                <label for="utm-grid-name" class="text-sm md:text-base text-content">Nom du fichier :</label>
                                <input type="text" id="utm-grid-name" class="input-field px-3 py-2 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-base" value="Grille_UTM_1km">
                            </div>
                            <div class="flex flex-col space-y-1">
                                <label class="text-sm md:text-base text-content">Couleur des lignes :</label>
                                <div class="flex flex-wrap gap-2" id="utm-color-options">
                                    <div class="color-option" data-color="#FFFFFF" style="background-color: #FFFFFF; border: 1px solid #ccc;"></div>
                                    <div class="color-option" data-color="#000000" style="background-color: #000000;"></div>
                                    <div class="color-option selected" data-color="#FF0000" style="background-color: #FF0000;"></div>
                                    <div class="color-option" data-color="#FFA500" style="background-color: #FFA500;"></div>
                                    <div class="color-option" data-color="#FFFF00" style="background-color: #FFFF00;"></div>
                                    <div class="color-option" data-color="#008000" style="background-color: #008000;"></div>
                                    <div class="color-option" data-color="#0000FF" style="background-color: #0000FF;"></div>
                                    <div class="color-option" data-color="#800080" style="background-color: #800080;"></div>
                                    <div class="color-option" data-color="#A52A2A" style="background-color: #A52A2A;"></div>
                                    <div class="color-option" data-color="#808080" style="background-color: #808080;"></div>
                                </div>
                                <input type="hidden" id="utm-grid-color" value="#FF0000">
                            </div>
                        </div>
                         <div class="space-y-3">
                             <div class="flex flex-col space-y-1">
                                <label for="utm-transparency" class="text-sm md:text-base text-content">Transparence des lignes :</label>
                                <div class="flex space-x-2 items-center">
                                    <input type="range" id="utm-transparency" class="w-full" min="0" max="100" value="30">
                                    <span id="utm-transparency-value" class="text-sm text-content">30%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <section class="flex justify-center">
                    <button id="generate-utm-button" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg text-lg font-semibold shadow-lg transform transition duration-200 hover:scale-105">GÉNÉRER GRILLE UTM</button>
                </section>
            </div>

            <div id="loading-indicator" class="hidden mt-4 flex flex-col items-center">
                <div class="loading-spinner mb-2"></div>
                <p id="loading-message" class="text-sm text-secondary">Génération en cours...</p>
            </div>
            
            <div id="error-message" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-center dark:bg-red-900 dark:text-red-300">
            </div>
        </main>
        
        <!-- Help Modal -->
        <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="card bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-2xl w-full max-h-[80vh] p-6 flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-content">Aide - Convertisseurs & Générateurs de Carroyage</h3>
                    <button id="close-help" class="text-gray-400 hover:text-gray-500 dark:text-gray-300 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <!-- Le contenu scrollable est dans ce conteneur -->
                <div id="help-content-container" class="prose dark:prose-invert max-w-none text-content space-y-4 flex-1 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <!-- Bannière de mise à jour -->
    <div id="update-banner" class="hidden fixed bottom-4 left-1/2 -translate-x-1/2 bg-blue-600 text-white p-4 rounded-lg shadow-xl flex items-center gap-4 z-50">
      <p>Une nouvelle version est disponible.</p>
      <button id="reload-button" class="bg-white text-blue-600 font-bold py-1 px-3 rounded hover:bg-blue-100">
        Actualiser
      </button>
    </div>
    
    <!-- Scripts -->
    <script src="helpContent.js"></script>
    <script src="carroyageUTM.js"></script>
    <script src="carroyageCado.js"></script>
    <script src="imagetoprint.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                document.documentElement.classList.toggle('dark', event.matches);
            });
            
            initIconDictionaries();
            document.getElementById('help-content-container').innerHTML = HELP_CONTENT_HTML;
            initUI();
            setupEventListeners();
            displayAppVersion(); 
            registerServiceWorker(); 
        });

        function initUI() {
            document.querySelectorAll('#color-options .color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('#color-options .color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('grid-color').value = this.dataset.color;
                    document.getElementById('grid-color-name').value = this.dataset.name;
                    updateDynamicGridName();
                });
            });
            
            document.querySelectorAll('#utm-color-options .color-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('#utm-color-options .color-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('utm-grid-color').value = this.dataset.color;
                });
            });

            document.getElementById('transparency-value').textContent = `${document.getElementById('transparency').value}%`;
            document.getElementById('deviation-value').textContent = `${document.getElementById('deviation').value}°`;
            document.getElementById('utm-transparency-value').textContent = `${document.getElementById('utm-transparency').value}%`;
            
            document.querySelectorAll('input[name="grid-option"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isDefault = this.value === 'default';
                    document.getElementById('default-grid-options').classList.toggle('hidden', !isDefault);
                    document.getElementById('custom-grid-options').classList.toggle('hidden', isDefault);
                    updateDynamicGridName();
                });
            });
        }

        function setupEventListeners() {
            document.getElementById('transparency').addEventListener('input', e => { document.getElementById('transparency-value').textContent = `${e.target.value}%`; });
            document.getElementById('utm-transparency').addEventListener('input', e => { document.getElementById('utm-transparency-value').textContent = `${e.target.value}%`; });

            document.getElementById('convert-from-decimal').addEventListener('click', convertFromDecimal);
            document.getElementById('convert-from-dms').addEventListener('click', convertFromDMS);
            document.getElementById('convert-from-plus').addEventListener('click', convertFromPlusCode);
            document.getElementById('convert-from-mercator').addEventListener('click', convertFromMercator);
            document.getElementById('convert-from-utm').addEventListener('click', convertFromUTM);
            
            document.getElementById('view-on-maps-decimal').addEventListener('click', () => viewOnMaps('decimal'));
            document.getElementById('view-on-maps-dms').addEventListener('click', () => viewOnMaps('dms'));
            document.getElementById('view-on-maps-plus').addEventListener('click', () => viewOnMaps('plus'));
            document.getElementById('view-on-maps-mercator').addEventListener('click', () => viewOnMaps('mercator'));
            document.getElementById('view-on-maps-utm').addEventListener('click', () => viewOnMaps('utm'));

            const deviationInput = document.getElementById('deviation');
            const deviationValueSpan = document.getElementById('deviation-value');
            const generateImageButton = document.getElementById('generate-image-button');
            const resetButton = document.getElementById('reset-deviation');
            
            // CORRECTION 4: Mise à jour de la logique d'activation du bouton.
            const updateImageButtonState = () => {
                const isDeviationZero = parseInt(deviationInput.value, 10) === 0;
                
                const gridOption = document.querySelector('input[name="grid-option"]:checked').value;
                const refPoint = document.querySelector('input[name="reference-point"]:checked').value;
                
                let isPrintableSetup = false;
                
                if (isDeviationZero) {
                    if (refPoint === 'origin') {
                        isPrintableSetup = true;
                    }
                    else if (refPoint === 'center') {
                        const isGridOptionDefault = gridOption === 'default';
                        // La génération d'image est valide si le type de grille est Z18 ou Q12.
                        const printableGridTypes = ['Z18', 'Q12'];
                        const selectedGridType = document.querySelector('input[name="grid-type"]:checked').value;
                        if (isGridOptionDefault && printableGridTypes.includes(selectedGridType)) {
                            isPrintableSetup = true;
                        }
                    }
                }
                
                generateImageButton.disabled = !isPrintableSetup;

                if (isPrintableSetup) {
                    generateImageButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    generateImageButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
                } else {
                    generateImageButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                    generateImageButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                }
            };
            
            document.querySelectorAll('.grid-parameter').forEach(el => {
                const eventType = (el.type === 'range' || el.type === 'number' || el.type === 'text') ? 'input' : 'change';
                el.addEventListener(eventType, () => {
                    updateDynamicGridName();
                    updateImageButtonState();
                });
            });

            deviationInput.addEventListener('input', () => {
                deviationValueSpan.textContent = `${deviationInput.value}°`;
            });
            
            resetButton.addEventListener('click', () => {
                deviationInput.value = 0;
                deviationValueSpan.textContent = "0°";
                updateDynamicGridName();
                updateImageButtonState();
            });

            generateImageButton.addEventListener('click', generateImageToPrint);

            updateImageButtonState();
            
            const helpModal = document.getElementById('help-modal');
            document.getElementById('helpBtn').addEventListener('click', () => helpModal.classList.remove('hidden'));
            document.getElementById('close-help').addEventListener('click', () => helpModal.classList.add('hidden'));
            helpModal.addEventListener('click', e => { if (e.target === helpModal) helpModal.classList.add('hidden'); });
            
            document.getElementById('generate-button').addEventListener('click', generateGrid);
            document.getElementById('generate-utm-button').addEventListener('click', generateUTMGrid);
        }
        
        function displayAppVersion() {
          if (typeof APP_VERSION !== 'undefined') {
            const displayVersion = `v${APP_VERSION}`;
            document.title = `Générateur CADO ${displayVersion}`;
            const titleElement = document.getElementById('app-title');
            if (titleElement) {
              titleElement.textContent = `Générateur de carroyage CADO ${displayVersion}`;
            }
          } else {
            console.error("La constante APP_VERSION n'a pas été trouvée. Avez-vous inclus version.js ?");
          }
        }

        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW enregistré:', registration);
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('Nouvelle version du SW détectée :', newWorker);
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated') {
                                    console.log('Nouveau SW activé. Affichage de la bannière.');
                                    showUpdateBanner();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Échec de l\'enregistrement SW:', error);
                    });
            }
        }
        
        function showUpdateBanner() {
            const banner = document.getElementById('update-banner');
            const reloadButton = document.getElementById('reload-button');
            if (banner) banner.classList.remove('hidden');
            if (reloadButton) {
                reloadButton.addEventListener('click', () => {
                    window.location.reload();
                });
            }
        }
    </script>
</body>

</html>
